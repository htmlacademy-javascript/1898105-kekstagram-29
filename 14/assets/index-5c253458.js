(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function n(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function s(o){if(o.ep)return;o.ep=!0;const c=n(o);fetch(o.href,c)}})();const ne=5e3,p=e=>e.key==="Escape",oe=(e,t)=>{const n=document.createElement("div");n.style.zIndex="100",n.style.position="absolute",n.style.left="0",n.style.top="0",n.style.right="0",n.style.padding="10px 3px",n.style.fontSize="30px",n.style.textAlign="center",n.style.backgroundColor=t,n.textContent=e,document.body.append(n),setTimeout(()=>{n.remove()},ne)},ce=(e,t=500)=>{let n;return(...s)=>{clearTimeout(n),n=setTimeout(()=>e.apply(globalThis,s),t)}},se="https://29.javascript.pages.academy/kekstagram",I={GET_DATA:"/data",SEND_DATA:"/"},U={GET:"GET",POST:"POST"},F={GET_DATA:"Не удалось загрузить данные. Попробуйте обновить страницу",SEND_DATA:"Не удалось отправить форму. Попробуйте ещё раз"},N=(e,t,n=U.GET,s=null)=>fetch(`${se}${e}`,{method:n,body:s}).then(o=>{if(!o.ok)throw new Error;return o.json()}).catch(()=>{throw new Error(t)}),re=()=>N(I.GET_DATA,F.GET_DATA),ie=e=>N(I.SEND_DATA,F.SEND_DATA,U.POST,e),ae=document.querySelector(".scale"),b=document.querySelector(".scale__control--value"),le=document.querySelector(".img-upload__preview img"),l={STEP:25,MAX:100,MIN:25,DEFAULT:100};b.value=`${l.DEFAULT}%`;const B=e=>{le.style.transform=`scale(${e/l.DEFAULT})`,b.value=`${e}%`},w=e=>{const n=parseInt(b.value,10)+l.STEP*e;n<l.MIN||n>l.MAX||B(n)},ue=e=>{e.target.classList.contains("scale__control--smaller")?w(-1):e.target.classList.contains("scale__control--bigger")&&w(1)},O=()=>{B(l.DEFAULT)};ae.addEventListener("click",ue);const $=[{name:"none",filter:"none",min:0,max:100,step:1,unit:""},{name:"chrome",filter:"grayscale",min:0,max:1,step:.1,unit:""},{name:"sepia",filter:"sepia",min:0,max:1,step:.1,unit:""},{name:"marvin",filter:"invert",min:0,max:100,step:1,unit:"%"},{name:"phobos",filter:"blur",min:0,max:3,step:.1,unit:"px"},{name:"heat",filter:"brightness",min:1,max:3,step:.1,unit:""}],r=$[0];let i=r;const M=document.querySelector(".img-upload__preview img"),de=document.querySelector(".effects"),y=document.querySelector(".effect-level__slider"),H=document.querySelector(".img-upload__effect-level"),me=document.querySelector(".effect-level__value"),G=()=>i===r,pe=()=>{H.classList.remove("hidden")},C=()=>{H.classList.add("hidden")},R=()=>{y.noUiSlider.updateOptions({range:{min:i.min,max:i.max},step:i.step,start:r.max}),pe(),G()&&C()},fe=e=>{e.target.classList.contains("effects__radio")&&(i=$.find(t=>t.name===e.target.value),M.className=`effects__preview--${i.name}`,R())},ge=()=>{const e=y.noUiSlider.get();M.style.filter=G()?r.filter:`${i.filter}(${e}${i.unit})`,me.value=e},V=()=>{i=r,C(),R()};noUiSlider.create(y,{range:{min:r.min,max:r.max},start:r.max,step:r.step,connect:"lower"});C();de.addEventListener("change",fe);y.noUiSlider.on("update",ge);const ye=document.querySelector("#success").content.querySelector(".success"),_e=document.querySelector("#error").content.querySelector(".error"),q=()=>{const e=document.querySelector(".error")||document.querySelector(".success");document.body.removeChild(e),document.removeEventListener("keydown",K,!0),document.removeEventListener("click",j)};function K(e){p(e)&&(e.stopPropagation(),q())}function j(e){e.target.closest(".success__inner")||q()}const z=(e,t)=>{document.body.append(e),document.addEventListener("keydown",K,!0),document.addEventListener("click",j),e.querySelector(t).addEventListener("click",q)},Se=()=>z(ye,".success__button"),he=()=>z(_e,".error__button"),Ee=5,Le=["png","jpg","jpeg"],ve=/^#[a-zа-яё0-9]{1,19}$/i,be=document.querySelector("body"),X=document.querySelector(".img-upload__input"),W=document.querySelector(".img-upload__overlay"),Ce=document.querySelector(".img-upload__cancel"),a=document.querySelector(".img-upload__form"),x=a.querySelector(".img-upload__preview img"),_=a.querySelector(".text__hashtags"),qe=document.querySelector(".text__description"),g=document.querySelector(".img-upload__submit"),Te=a.querySelectorAll(".effects__preview"),Y=()=>{W.classList.add("hidden"),document.body.classList.remove("modal-open")},J={IDLE:"Опубликовать",SENDING:"Публикую..."},u=new Pristine(a,{classTo:"img-upload__field-wrapper",errorTextParent:"img-upload__field-wrapper"}),De=()=>{g.disabled=!0,g.textContent=J.SENDING},we=()=>{g.disabled=!1,g.textContent=J.IDLE},T=e=>e.trim().split(" ").filter(t=>!!t.length),xe=e=>T(e).every(t=>ve.test(t)),Ae=e=>T(e).length<=Ee,ke=e=>{const t=T(e).map(n=>n.toLowerCase());return t.length===new Set(t).size};u.addValidator(_,Ae,"Много хештегов",3,!0);u.addValidator(_,ke,"Не уникальный хештег",1,!0);u.addValidator(_,xe,"Не правильный хештег",2,!0);const Pe=e=>{a.addEventListener("submit",t=>{t.preventDefault(),u.validate()&&(De(),ie(new FormData(t.target)).then(e).catch(()=>{he()}).finally(we))})},Q=e=>{p(e)&&(e.preventDefault(),Y(),V(),O(),a.reset(),u.reset())},Ie=e=>{const t=e.name.toLowerCase();return Le.some(n=>t.endsWith(n))},Ue=()=>{const e=X.files[0];e&&Ie(e)&&(x.src=URL.createObjectURL(e),Te.forEach(t=>{t.style.backgroundImage=`url('${x.src}')`})),W.classList.remove("hidden"),be.classList.add("modal-open"),document.addEventListener("keydown",Q)},Z=()=>{Se(),Y(),V(),O(),a.reset(),u.reset(),document.removeEventListener("keydown",Q)},Fe=e=>{p(e)&&e.stopPropagation()},Ne=e=>{p(e)&&e.stopPropagation()};X.addEventListener("change",Ue);Ce.addEventListener("click",Z);qe.addEventListener("keydown",Fe);_.addEventListener("keydown",Ne);Pe(Z);const Be=document.querySelector("#picture").content.querySelector(".picture"),Oe=({url:e,likes:t,comments:n,description:s,id:o})=>{const c=Be.cloneNode(!0);return c.querySelector(".picture__img").src=e,c.querySelector(".picture__img").alt=s,c.querySelector(".picture__comments").textContent=n.length,c.querySelector(".picture__likes").textContent=t,c.dataset.thumbnailId=o,c},$e=(e,t)=>{const n=document.createDocumentFragment();e.forEach(s=>{const o=Oe(s);n.append(o)}),t.append(n)},Me=document.querySelector(".social__comments"),He=document.querySelector("#comment").content.querySelector(".social__comment"),A=e=>{const t=document.createDocumentFragment();e.forEach(n=>{const s=He.cloneNode(!0),o=s.querySelector(".social__picture");o.src=n.avatar,o.alt=n.name,s.querySelector(".social__text").textContent=n.message,t.append(s)}),Me.append(t)},D=document.querySelector(".big-picture"),Ge=document.querySelector(".big-picture__img"),Re=Ge.querySelector("img"),Ve=document.querySelector(".social__caption"),Ke=document.querySelector(".likes-count"),je=document.querySelector(".big-picture__cancel"),S=document.querySelector(".comments-count"),m=document.querySelector(".comments-loader"),k=document.querySelector(".social__comment-count"),ze=()=>{D.classList.add("hidden"),document.querySelector(".social__comments").textContent="",document.body.classList.remove("modal-open")},Xe=e=>{p(e)&&(e.preventDefault(),D.classList.add("hidden"),document.querySelector(".social__comments").textContent="",document.body.classList.remove("modal-open"))},We=e=>{m.classList.remove("hidden"),document.body.classList.add("modal-open");let t=5;const{url:n,likes:s,comments:o,description:c}=e;o.length<=t&&(t=o.length,m.classList.add("hidden")),S.textContent=o.length,k.textContent=`${t} из ${S.textContent} комментариев`,D.classList.remove("hidden"),document.body.classList.add("modal-open"),Re.src=n,Ve.textContent=c,Ke.textContent=s,A(o.slice(0,t));const d=()=>{m.classList.remove("hidden"),document.querySelector(".social__comments").textContent="",t=t+5,t>=o.length&&(t=o.length,m.classList.add("hidden")),A(o.slice(0,t)),k.textContent=`${t} из ${S.textContent} комментариев`};m.addEventListener("click",d),je.addEventListener("click",ze),document.addEventListener("keydown",Xe)},P=document.querySelector(".pictures");let h=[];const Ye=e=>{const t=e.target.closest("[data-thumbnail-id]");if(!t)return;e.preventDefault();const n=h.find(s=>s.id===+t.dataset.thumbnailId);We(n)},ee=e=>{h=e,$e(h,P),P.addEventListener("click",Ye)},Je=10,E={DEFAUIT:"filter-default",RANDOM:"filter-random",DISCUSSED:"filter-discussed"},L=document.querySelector(".img-filters"),Qe=ce(ee),Ze=()=>Math.random()-.5,et=(e,t)=>t.comments.length-e.comments.length;let v=E.DEFAULT,f=[];const tt=document.querySelector(".pictures"),te=()=>{switch(v){case E.RANDOM:return[...f].sort(Ze).slice(0,Je);case E.DISCUSSED:return[...f].sort(et);default:return f}},nt=()=>{L.addEventListener("click",e=>{if(!e.target.classList.contains("img-filters__button"))return;const t=e.target;t.id!==v&&(L.querySelector(".img-filters__button--active").classList.remove("img-filters__button--active"),t.classList.add("img-filters__button--active"),v=t.id,tt.querySelectorAll(".picture").forEach(n=>n.remove()),Qe(te()))})},ot=e=>{L.classList.remove("img-filters--inactive"),f=[...e],nt()};re().then(e=>{ot(e),ee(te())}).catch(e=>{oe(e.message,"red")});
